import type {
    VideoSource,
    VideoItem,
    ApiSearchResponse,
} from '@/lib/types';
import { fetchWithTimeout, withRetry } from './http-utils';

/**
 * 內置繁體轉簡體對照表
 * 提取自 opencc-js t2cn 核心邏輯
 */
const T2S_MAP: Record<string, string> = {
    "一": "一", "七": "七", "萬": "万", "丈": "丈", "三": "三", "上": "上", "下": "下", "不": "不", "與": "与", "醜": "丑", "專": "专", "且": "且", "世": "世", "業": "业", "東": "东", "絲": "丝", "丟": "丢", "兩": "两", "嚴": "严", "喪": "丧", "個": "个", "中": "中", "豐": "丰", "串": "串", "臨": "临", "為": "为", "主": "主", "舉": "举", "久": "久", "麼": "么", "義": "义", "之": "之", "乎": "乎", "乏": "乏", "樂": "乐", "乘": "乘", "九": "九", "乞": "乞", "也": "也", "習": "习", "鄉": "乡", "書": "书", "買": "买", "亂": "乱", "了": "了", "予": "予", "爭": "争", "事": "事", "二": "二", "於": "于", "虧": "亏", "雲": "云", "互": "互", "五": "五", "井": "井", "亞": "亚", "些": "些", "亡": "亡", "交": "交", "亦": "亦", "產": "产", "享": "享", "京": "京", "亮": "亮", "親": "亲", "人": "人", "億": "亿", "什": "什", "仁": "仁", "僅": "仅", "仇": "仇", "今": "今", "介": "介", "仍": "仍", "從": "从", "崙": "仑", "倉": "仓", "仔": "仔", "他": "他", "付": "付", "代": "代", "令": "令", "以": "以", "們": "们", "件": "件", "價": "价", "任": "任", "份": "份", "仿": "仿", "企": "企", "伊": "伊", "伍": "伍", "休": "休", "眾": "众", "優": "优", "伙": "伙", "夥": "伙", "會": "会", "偉": "伟", "傳": "传", "傷": "伤", "倫": "伦", "伯": "伯", "估": "估", "伴": "伴", "伸": "伸", "似": "似", "但": "但", "位": "位", "低": "低", "住": "住", "體": "体", "何": "何", "余": "余", "餘": "余", "佛": "佛", "作": "作", "你": "你", "佩": "佩", "佳": "佳", "佶": "佶", "使": "使", "例": "例", "供": "供", "依": "依", "僥": "侥", "側": "侧", "侵": "侵", "便": "便", "促": "促", "俊": "俊", "俗": "俗", "保": "保", "信": "信", "倆": "俩", "修": "修", "俱": "俱", "倍": "倍", "倒": "倒", "候": "候", "借": "借", "值": "值", "傾": "倾", "假": "假", "偏": "偏", "做": "做", "停": "停", "健": "健", "偶": "偶", "偷": "偷", "償": "偿", "傍": "傍", "儲": "储", "催": "催", "傻": "傻", "像": "像", "僚": "僚", "僻": "僻", "兒": "儿", "元": "元", "兄": "兄", "充": "充", "兆": "兆", "先": "先", "光": "光", "克": "克", "免": "免", "黨": "党", "入": "入", "全": "全", "八": "八", "公": "公", "六": "六", "蘭": "兰", "共": "共", "關": "关", "興": "兴", "兵": "兵", "其": "其", "具": "具", "典": "典", "茲": "兹", "養": "养", "兼": "兼", "冀": "冀", "內": "内", "冊": "册", "再": "再", "寫": "写", "軍": "军", "農": "农", "冠": "冠", "冤": "冤", "冬": "冬", "衝": "冲", "沖": "冲", "決": "决", "況": "况", "冷": "冷", "淨": "净", "淒": "凄", "準": "准", "涼": "凉", "減": "减", "湊": "凑", "幾": "几", "凡": "凡", "鳳": "凤", "凱": "凯", "兇": "凶", "凶": "凶", "出": "出", "擊": "击", "函": "函", "鑿": "凿", "分": "分", "切": "切", "刊": "刊", "劃": "划", "列": "列", "劉": "刘", "則": "则", "剛": "刚", "創": "创", "初": "初", "刪": "删", "判": "判", "利": "利", "別": "别", "到": "到", "制": "制", "券": "券", "刺": "刺", "刻": "刻", "劊": "刽", "劑": "剂", "削": "削", "前": "前", "剎": "剎", "剝": "剥", "劇": "剧", "剩": "剩", "割": "割", "力": "力", "勸": "劝", "辦": "办", "功": "功", "加": "加", "務": "务", "劣": "务", "動": "动", "助": "助", "努": "努", "劫": "劫", "勵": "励", "勁": "劲", "勞": "劳", "勢": "势", "勇": "勇", "勒": "勒", "募": "募", "勤": "勤", "勾": "勾", "包": "包", "匈": "匈", "化": "化", "北": "北", "匹": "匹", "區": "区", "醫": "医", "匿": "匿", "十": "十", "千": "千", "升": "升", "午": "午", "半": "半", "華": "华", "協": "协", "單": "单", "賣": "卖", "南": "南", "博": "博", "占": "占", "佔": "占", "卡": "卡", "衛": "卫", "印": "印", "危": "危", "即": "即", "卻": "却", "卵": "卵", "廠": "厂", "歷": "历", "曆": "历", "厲": "厉", "壓": "压", "厭": "厌", "廁": "厕", "釐": "厘", "原": "原", "廂": "厢", "去": "去", "縣": "县", "參": "参", "又": "又", "叉": "叉", "及": "及", "友": "友", "雙": "双", "反": "反", "發": "发", "髮": "发", "叔": "叔", "取": "取", "受": "受", "變": "变", "口": "口", "古": "古", "句": "句", "另": "另", "只": "只", "叫": "叫", "召": "召", "可": "可", "台": "台", "臺": "台", "史": "史", "右": "右", "葉": "叶", "號": "号", "司": "司", "吃": "吃", "各": "各", "合": "合", "吉": "吉", "同": "同", "名": "名", "後": "后", "向": "向", "嚇": "吓", "呂": "吕", "嗎": "吗", "君": "君", "吧": "吧", "含": "含", "聽": "听", "啟": "启", "吳": "吴", "吵": "吵", "吸": "吸", "吹": "吹", "吻": "吻", "吼": "吼", "吾": "吾", "呀": "呀", "告": "告", "員": "员", "呢": "呢", "周": "周", "週": "周", "味": "味", "呼": "呼", "命": "命", "咀": "咀", "和": "和", "品": "品", "哈": "哈", "響": "响", "啞": "哑", "譁": "哗", "哥": "哥", "哪": "哪", "哭": "哭", "哲": "哲", "唉": "唉", "唱": "唱", "商": "商", "啊": "啊", "啦": "啦", "善": "善", "喊": "喊", "喔": "喔", "喜": "喜", "嗯": "嗯", "嘲": "嘲", "嘴": "嘴", "嘿": "嘿", "器": "器", "噩": "噩", "嚼": "嚼", "四": "四", "回": "回", "因": "因", "團": "团", "園": "园", "困": "困", "圍": "围", "固": "固", "國": "国", "圖": "图", "圓": "圆", "圈": "圆", "土": "土", "聖": "圣", "在": "在", "地": "地", "場": "场", "址": "址", "均": "均", "壞": "坏", "坐": "坐", "塊": "块", "堅": "坚", "壇": "坛", "坦": "坦", "壟": "垄", "型": "型", "壘": "垒", "埋": "埋", "城": "城", "培": "培", "基": "基", "堂": "堂", "堆": "堆", "墮": "堕", "堪": "堪", "堵": "堵", "塑": "塑", "塔": "塔", "塞": "塞", "填": "填", "境": "境", "墓": "墓", "牆": "墙", "增": "增", "墟": "墟", "壯": "壮", "聲": "声", "殼": "壳", "處": "处", "備": "备", "複": "复", "夕": "夕", "外": "外", "多": "多", "夜": "夜", "夠": "够", "大": "大", "天": "天", "太": "太", "夫": "夫", "央": "央", "失": "失", "頭": "头", "誇": "夸", "夾": "夹", "奪": "夺", "奇": "奇", "奉": "奉", "奮": "奋", "奏": "奏", "契": "契", "奔": "奔", "獎": "奖", "套": "套", "奠": "奠", "奢": "奢", "女": "女", "奴": "奴", "她": "她", "好": "好", "如": "如", "婦": "妇", "媽": "妈", "妖": "妖", "妙": "妙", "妥": "妥", "妨": "妨", "妹": "妹", "始": "始", "姑": "姑", "姓": "姓", "委": "委", "薑": "姜", "姨": "姨", "姻": "姻", "威": "威", "娃": "娃", "婁": "娄", "娘": "娘", "娛": "娱", "娶": "娶", "婆": "婆", "婚": "婚", "嬰": "婴", "媒": "媒", "嫉": "嫉", "嫌": "嫌", "子": "子", "孔": "孔", "字": "字", "存": "存", "孫": "孙", "孤": "孤", "學": "学", "孩": "孩", "孽": "孽", "寧": "宁", "宅": "宅", "守": "守", "安": "安", "完": "完", "宗": "宗", "官": "官", "定": "定", "宜": "宜", "寶": "宝", "實": "实", "寵": "宠", "審": "审", "客": "客", "宣": "宣", "憲": "宪", "宰": "宰", "害": "害", "家": "家", "傢": "家", "容": "容", "寄": "寄", "密": "密", "富": "富", "寒": "寒", "察": "察", "寡": "寡", "對": "对", "尋": "寻", "導": "导", "封": "封", "射": "射", "將": "将", "尊": "尊", "小": "小", "少": "少", "爾": "尔", "尚": "尚", "嘗": "尝", "尤": "尤", "就": "就", "尷": "尴", "尺": "尺", "盡": "尽", "尾": "尾", "局": "局", "層": "层", "居": "居", "屈": "屈", "屆": "届", "屋": "屋", "屎": "屎", "展": "展", "屬": "属", "山": "山", "歲": "岁", "豈": "岂", "崗": "岗", "岸": "岸", "崇": "崇", "州": "州", "工": "工", "左": "左", "巧": "巧", "鉅": "巨", "差": "差", "己": "己", "已": "已", "巴": "巴", "巷": "巷", "幣": "币", "市": "市", "布": "布", "師": "师", "希": "希", "帝": "帝", "帶": "带", "席": "席", "幫": "帮", "常": "常", "幕": "幕", "幹": "干", "乾": "干", "平": "平", "年": "年", "並": "并", "幸": "幸", "倖": "幸", "幻": "幻", "幼": "幼", "廣": "广", "莊": "庄", "庇": "庇", "床": "床", "序": "序", "庫": "库", "應": "应", "底": "底", "店": "店", "府": "府", "龐": "庞", "廢": "废", "度": "度", "座": "座", "庭": "庭", "庶": "庶", "康": "康", "庸": "庸", "廊": "廊", "廖": "廖", "延": "延", "建": "建", "開": "开", "異": "异", "棄": "弃", "弄": "弄", "弊": "弊", "式": "式", "引": "引", "弟": "弟", "張": "张", "彌": "弥", "弱": "弱", "彈": "弹", "強": "强", "歸": "归", "當": "当", "錄": "录", "形": "形", "彩": "彩", "彰": "彰", "影": "影", "役": "役", "徹": "彻", "彼": "彼", "往": "往", "征": "征", "徵": "征", "徑": "径", "逕": "径", "待": "待", "很": "很", "律": "律", "徒": "徒", "得": "得", "微": "微", "德": "德", "徽": "徽", "心": "心", "必": "必", "憶": "忆", "忍": "忍", "志": "志", "誌": "志", "忘": "忘", "忙": "忙", "忠": "忠", "快": "快", "念": "念", "忽": "忽", "懷": "怀", "態": "态", "怎": "怎", "怒": "怒", "怕": "怕", "憐": "怜", "思": "思", "急": "急", "性": "性", "怨": "怨", "怪": "怪", "總": "总", "戀": "恋", "恍": "恍", "恐": "恐", "恆": "恒", "恢": "恢", "恨": "恨", "恩": "恩", "息": "息", "恰": "恰", "懇": "恳", "惡": "恶", "悉": "悉", "悔": "悔", "悟": "悟", "您": "您", "懸": "悬", "憫": "悯", "悲": "悲", "情": "情", "驚": "惊", "惑": "惑", "惕": "惕", "惜": "惜", "慘": "惨", "慣": "惯", "想": "想", "愈": "愈", "意": "意", "愚": "愚", "感": "感", "憤": "愤", "願": "愿", "慈": "慈", "慢": "慢", "慰": "慰", "憾": "憾", "懂": "懂", "懶": "懒", "戲": "戏", "成": "成", "我": "我", "或": "或", "戰": "战", "戚": "戚", "截": "截", "戴": "戴", "戶": "户", "房": "房", "所": "所", "扁": "扁", "手": "手", "才": "才", "撲": "扑", "打": "打", "扔": "扔", "託": "托", "扛": "扛", "扣": "扣", "執": "执", "擴": "扩", "掃": "扫", "揚": "扬", "扭": "扭", "扮": "扮", "扯": "扯", "擾": "扰", "批": "批", "扼": "扼", "找": "找", "承": "承", "技": "技", "抄": "抄", "把": "把", "抑": "抑", "抒": "抒", "抓": "抓", "投": "投", "抗": "抗", "摺": "折", "折": "折", "撫": "抚", "搶": "抢", "護": "护", "報": "报", "披": "披", "抬": "抬", "抱": "抱", "抵": "抵", "押": "押", "抽": "抽", "擔": "担", "拆": "拆", "拉": "拉", "拍": "拍", "拒": "拒", "拓": "拓", "拖": "拖", "拘": "拘", "招": "招", "拜": "拜", "擬": "拟", "攏": "拢", "擁": "拥", "撥": "拨", "擇": "择", "括": "括", "拼": "拼", "拿": "拿", "持": "持", "掛": "挂", "指": "按", "挑": "挑", "挖": "挖", "擠": "挤", "揮": "挥", "挨": "挨", "挫": "挫", "振": "振", "挺": "挺", "挽": "挽", "捅": "捅", "捉": "捉", "捐": "捐", "捕": "捕", "撈": "捞", "損": "损", "換": "换", "據": "据", "掀": "掀", "掉": "掉", "掌": "掌", "掏": "掏", "掐": "排", "掘": "掘", "探": "探", "接": "接", "控": "控", "推": "推", "描": "描", "提": "提", "插": "插", "握": "握", "揣": "揣", "揪": "揪", "揭": "揭", "援": "援", "擱": "搁", "搜": "搜", "搞": "搞", "攝": "摄", "擺": "摆", "搖": "摇", "攤": "摊", "摘": "摘", "摧": "摧", "摩": "摩", "撐": "撑", "撤": "撤", "撬": "撬", "播": "播", "擅": "擅", "攢": "攒", "攫": "攫", "支": "支", "收": "收", "改": "改", "攻": "攻", "放": "放", "政": "故", "效": "效", "敵": "敌", "敏": "敏", "救": "救", "教": "教", "斂": "敛", "敢": "敢", "散": "散", "敬": "敬", "數": "数", "整": "整", "文": "文", "鬥": "斗", "料": "料", "斥": "斥", "斷": "断", "斯": "斯", "新": "新", "方": "方", "施": "施", "旁": "旁", "旅": "旅", "旋": "旋", "族": "族", "旗": "旗", "無": "无", "既": "既", "日": "日", "旦": "旦", "舊": "旧", "早": "早", "時": "时", "昌": "昌", "明": "明", "昏": "昏", "易": "易", "星": "星", "春": "春", "昧": "昧", "昨": "昨", "是": "是", "顯": "显", "曉": "晓", "晚": "晚", "普": "普", "景": "景", "晰": "晰", "晴": "晴", "智": "智", "暫": "暂", "暇": "暇", "暑": "暑", "暖": "暖", "暗": "暗", "暴": "暴", "曲": "曲", "更": "更", "曾": "曾", "替": "替", "最": "最", "月": "月", "有": "有", "朋": "朋", "服": "服", "朔": "朔", "望": "望", "朝": "朝", "期": "期", "木": "木", "未": "未", "末": "末", "本": "本", "術": "术", "機": "机", "殺": "杀", "雜": "杂", "權": "权", "材": "材", "村": "村", "束": "束", "條": "条", "來": "来", "楊": "杨", "杯": "杯", "傑": "杰", "闆": "板", "板": "板", "極": "极", "構": "构", "枉": "枉", "析": "析", "林": "林", "果": "果", "枯": "枯", "架": "架", "某": "某", "染": "染", "查": "查", "標": "标", "棧": "栈", "欄": "栏", "樹": "树", "校": "样", "核": "核", "根": "根", "格": "格", "框": "框", "案": "案", "桌": "桌", "檔": "档", "樺": "桦", "桶": "桶", "夢": "梦", "梨": "梨", "梯": "梯", "檢": "检", "棒": "棒", "棚": "棚", "椅": "椅", "楚": "楚", "樓": "楼", "概": "概", "榜": "榜", "榨": "榨", "檻": "槛", "樟": "樟", "模": "模", "橫": "横", "欠": "欠", "次": "次", "歡": "欢", "歐": "欧", "慾": "欲", "款": "款", "歌": "歌", "止": "止", "正": "正", "此": "此", "步": "步", "武": "武", "歧": "歧", "死": "死", "殊": "殊", "殘": "残", "段": "段", "殷": "殷", "毀": "毁", "母": "母", "每": "每", "毒": "毒", "比": "比", "畢": "毕", "毛": "毛", "毫": "毫", "民": "民", "氣": "气", "水": "水", "永": "求", "彙": "汇", "漢": "汉", "江": "江", "污": "污", "汰": "汰", "沉": "沉", "沙": "沙", "溝": "沟", "沒": "没", "淪": "沦", "河": "河", "油": "油", "治": "治", "沾": "沾", "沿": "沿", "洩": "泄", "法": "法", "泛": "泛", "泡": "泡", "波": "波", "泣": "泣", "泥": "泥", "注": "注", "淚": "泪", "泯": "泯", "泰": "泰", "澤": "泽", "洋": "洗", "洛": "洛", "津": "津", "洪": "洪", "洲": "洲", "活": "活", "派": "派", "流": "流", "淺": "浅", "測": "测", "濟": "济", "瀏": "浏", "渾": "浑", "濃": "浓", "浩": "浩", "浪": "浪", "浮": "浮", "海": "海", "浸": "浸", "消": "消", "涉": "涉", "湧": "涌", "濤": "涛", "渦": "涡", "滌": "涤", "潤": "润", "漲": "涨", "液": "液", "涵": "涵", "淘": "淘", "淡": "淡", "深": "深", "混": "混", "添": "添", "清": "清", "漸": "渐", "滲": "渗", "渡": "渡", "渣": "渣", "溫": "温", "港": "港", "遊": "游", "游": "游", "湖": "湖", "灣": "湾", "濕": "湿", "源": "源", "滋": "滋", "滑": "滑", "滾": "滚", "滯": "滞", "滿": "满", "滴": "滴", "漂": "漂", "漏": "漏", "演": "演", "漫": "漫", "潛": "潜", "潮": "潮", "澡": "澡", "激": "激", "灌": "灌", "火": "火", "滅": "灭", "燈": "灯", "灰": "灰", "靈": "灵", "災": "灾", "燦": "灿", "炒": "炒", "炸": "炸", "點": "点", "爛": "烂", "烈": "烈", "煩": "烦", "燒": "烧", "熱": "热", "焉": "焉", "焦": "焦", "然": "然", "煤": "煤", "照": "照", "熊": "熊", "熟": "熟", "燃": "燃", "燥": "燥", "爆": "爆", "愛": "爱", "父": "父", "爺": "爷", "爸": "爸", "爽": "爽", "片": "片", "版": "版", "牌": "牌", "牙": "牙", "牛": "牛", "牢": "牢", "物": "物", "牲": "牲", "牽": "牵", "特": "特", "犧": "牺", "犯": "犯", "狀": "状", "猶": "犹", "狂": "狂", "狄": "狄", "狗": "狗", "獨": "独", "狹": "狭", "獄": "狱", "狼": "狼", "猛": "猛", "猜": "猜", "率": "率", "玉": "玉", "王": "王", "玩": "玩", "環": "环", "現": "现", "珊": "珊", "班": "班", "球": "球", "理": "理", "琴": "琴", "瑞": "瑞", "瑟": "瑟", "璋": "璋", "瓦": "瓦", "瓶": "瓶", "甚": "甚", "生": "生", "用": "用", "甫": "甫", "田": "田", "由": "由", "甲": "甲", "申": "申", "電": "电", "男": "男", "畫": "画", "暢": "畅", "界": "界", "留": "留", "略": "略", "番": "番", "疇": "畴", "疆": "疆", "疑": "疑", "療": "疗", "瘡": "疮", "疲": "疲", "病": "病", "癢": "痒", "痛": "痛", "登": "登", "白": "白", "百": "百", "皂": "皂", "的": "的", "皆": "皆", "皇": "皇", "皮": "皮", "益": "益", "監": "监", "盒": "盒", "蓋": "盖", "盤": "盘", "盟": "盟", "目": "目", "盯": "盯", "盲": "盲", "直": "直", "相": "相", "盼": "盼", "盾": "盾", "省": "省", "看": "看", "真": "真", "眷": "眷", "眼": "眼", "著": "着", "睛": "睛", "睡": "睡", "瞧": "瞧", "瞭": "瞭", "矛": "矛", "矣": "矣", "知": "知", "短": "短", "石": "石", "礦": "矿", "碼": "码", "研": "研", "破": "破", "砸": "砸", "礎": "础", "硬": "硬", "確": "确", "礙": "碍", "碗": "碗", "碧": "碧", "碰": "碰", "磁": "磁", "磨": "磨", "示": "示", "社": "社", "祖": "祖", "神": "神", "票": "票", "禁": "禁", "福": "福", "離": "离", "禽": "禽", "秀": "秀", "私": "私", "種": "种", "科": "科", "秒": "秒", "秩": "秩", "積": "积", "稱": "称", "移": "移", "稀": "稀", "程": "程", "稍": "稍", "稅": "税", "稚": "稚", "穩": "稳", "稻": "稻", "究": "究", "窮": "穷", "空": "空", "穿": "穿", "突": "突", "窗": "窗", "立": "立", "站": "站", "競": "竞", "竟": "竟", "章": "章", "童": "童", "端": "端", "竹": "竹", "竿": "竿", "笑": "笑", "筆": "笔", "符": "符", "笨": "笨", "第": "第", "等": "等", "築": "筑", "答": "答", "策": "策", "箏": "筝", "籌": "筹", "簽": "签", "籤": "签", "簡": "简", "算": "算", "管": "管", "篇": "篇", "籍": "籍", "類": "类", "粉": "粉", "粒": "粒", "粗": "粗", "糧": "粮", "粹": "粹", "精": "精", "糊": "糊", "糕": "糕", "糟": "糟", "係": "系", "素": "素", "索": "索", "緊": "紧", "紫": "紫", "累": "累", "繁": "繁", "糾": "纠", "紅": "红", "約": "约", "級": "级", "紀": "纪", "純": "纯", "綱": "纲", "納": "纳", "紛": "纷", "紙": "纸", "紐": "纽", "紓": "纾", "線": "线", "練": "练", "組": "组", "紳": "绅", "細": "细", "織": "织", "終": "终", "紹": "绍", "經": "经", "結": "结", "給": "给", "絡": "络", "絕": "绝", "統": "统", "繼": "继", "績": "绩", "緒": "绪", "續": "续", "繩": "绳", "維": "维", "綿": "绵", "綜": "综", "綠": "绿", "緩": "缓", "締": "缔", "編": "编", "縛": "缚", "縫": "缝", "縮": "缩", "繳": "缴", "缺": "缺", "網": "网", "羅": "罗", "罷": "罢", "罪": "罪", "置": "置", "署": "署", "羊": "羊", "美": "美", "羞": "羞", "群": "群", "翔": "翔", "翻": "翻", "翼": "翼", "耀": "耀", "老": "老", "考": "者", "而": "而", "耐": "耐", "耗": "耗", "耳": "耳", "耶": "耶", "聳": "耸", "恥": "耻", "聾": "聋", "職": "职", "聯": "联", "聚": "聚", "肉": "肉", "肌": "肌", "肘": "肘", "肚": "肚", "肝": "肝", "股": "股", "膚": "肤", "肩": "肩", "肪": "肪", "肯": "肯", "育": "育", "腎": "肾", "脅": "胁", "胃": "胃", "膽": "胆", "背": "背", "勝": "胜", "胞": "胞", "胡": "胡", "能": "能", "脂": "脂", "脆": "脆", "脈": "脉", "臟": "脏", "髒": "脏", "腦": "脑", "腳": "脚", "脫": "脱", "臉": "脸", "腐": "腐", "腥": "腥", "騰": "腾", "臂": "臂", "自": "自", "臭": "臭", "至": "至", "致": "致", "輿": "舆", "捨": "舍", "舒": "舒", "舞": "舞", "舟": "舟", "航": "航", "般": "般", "艦": "舰", "艙": "舱", "船": "船", "良": "良", "艱": "艰", "色": "色", "藝": "艺", "節": "节", "蘆": "芦", "芬": "芬", "花": "花", "甦": "苏", "苟": "苟", "若": "若", "苦": "苦", "英": "英", "範": "范", "茅": "茅", "草": "草", "薦": "荐", "荒": "荒", "盪": "荡", "榮": "荣", "藥": "药", "莫": "莫", "萊": "莱", "蓮": "莲", "獲": "获", "菜": "菜", "營": "营", "蕭": "萧", "落": "落", "葬": "葬", "蒙": "蒙", "蓄": "蓄", "藍": "蓝", "蔓": "蔓", "薄": "薄", "薪": "薪", "藏": "藏", "慮": "虑", "虛": "虚", "蟲": "虫", "雖": "虽", "蝕": "蚀", "蟻": "蚁", "螞": "蚂", "蚊": "蚊", "蛋": "蛋", "蛙": "蛙", "蛛": "蛛", "蜂": "蜂", "蝴": "蝴", "蝶": "蝶", "融": "融", "蠢": "蠢", "血": "血", "行": "行", "衡": "衡", "衣": "衣", "補": "补", "表": "表", "袋": "袋", "袖": "袖", "被": "被", "襲": "袭", "裁": "裁", "裂": "裂", "裝": "装", "裸": "裸", "西": "西", "要": "要", "覆": "覆", "見": "见", "觀": "观", "規": "规", "視": "视", "覽": "览", "覺": "觉", "角": "角", "解": "解", "觸": "触", "言": "言", "譽": "誉", "警": "警", "譬": "譬", "計": "计", "訂": "订", "認": "认", "討": "讨", "讓": "让", "議": "议", "訊": "讯", "記": "记", "講": "讲", "諱": "讳", "訝": "讶", "許": "许", "論": "论", "諷": "讽", "設": "设", "訪": "访", "證": "证", "評": "评", "識": "识", "訴": "诉", "詞": "词", "譯": "译", "試": "试", "詩": "试", "誠": "诚", "話": "话", "詢": "询", "該": "该", "詳": "详", "語": "语", "誤": "误", "說": "说", "請": "请", "諸": "诸", "讀": "读", "課": "课", "誰": "谁", "調": "调", "諒": "谅", "談": "谈", "謀": "谋", "謊": "谎", "謂": "谓", "謝": "谢", "謠": "谣", "謾": "谩", "謬": "谬", "象": "象", "貌": "貌", "貝": "贝", "負": "负", "財": "财", "責": "责", "敗": "败", "貨": "货", "質": "质", "販": "贩", "貪": "贪", "貧": "贫", "購": "购", "貫": "贯", "貼": "贴", "貴": "贵", "費": "费", "資": "资", "賭": "赌", "賞": "赏", "賴": "赖", "贅": "赘", "賺": "赚", "賽": "赛", "贊": "赞", "讚": "赞", "贏": "赢", "赤": "赤", "走": "走", "赴": "赴", "趕": "赶", "起": "起", "超": "超", "越": "越", "趨": "趋", "趟": "趟", "趣": "趣", "足": "足", "躍": "跃", "跋": "跋", "跑": "跑", "距": "距", "跟": "跟", "跨": "跨", "路": "路", "跳": "跳", "踐": "践", "踏": "踏", "踩": "踩", "蹲": "蹲", "身": "身", "躲": "躲", "車": "车", "軌": "轨", "轉": "转", "輪": "轮", "軟": "软", "轟": "轰", "輕": "轻", "載": "载", "較": "较", "輛": "辆", "輩": "辈", "輝": "辉", "輻": "辐", "輯": "辑", "輸": "输", "辛": "辛", "辜": "辜", "辭": "辞", "辣": "辣", "辨": "辨", "辯": "辩", "辱": "辱", "邊": "边", "達": "达", "遷": "迁", "迅": "迅", "過": "过", "邁": "迈", "迎": "迎", "運": "运", "近": "近", "返": "返", "還": "还", "這": "这", "進": "进", "遠": "远", "違": "违", "連": "连", "迫": "迫", "述": "述", "迷": "迷", "跡": "迹", "追": "追", "退": "退", "送": "送", "適": "适", "逃": "逃", "逆": "逆", "選": "选", "透": "透", "逐": "逐", "遞": "递", "途": "途", "通": "通", "逛": "逛", "速": "速", "造": "造", "逢": "逢", "逮": "逮", "逸": "逸", "邏": "逻", "遇": "遇", "遍": "遍", "遑": "遑", "道": "道", "遺": "遗", "遙": "遥", "遭": "遭", "遮": "遮", "遵": "遵", "避": "避", "鄧": "邓", "那": "那", "郵": "邮", "鄰": "邻", "鄭": "郑", "部": "部", "郭": "郭", "都": "都", "酋": "酋", "配": "配", "酒": "酒", "酷": "酷", "酸": "酸", "釀": "酿", "醒": "醒", "採": "采", "釋": "释", "裡": "里", "重": "重", "野": "野", "量": "量", "金": "金", "針": "针", "鈣": "钙", "鐘": "钟", "鋼": "钢", "欽": "钦", "鈕": "钮", "錢": "钱", "鑽": "钻", "鐵": "铁", "鉛": "铅", "銅": "铜", "鏟": "铲", "鏈": "链", "銷": "销", "鎖": "锁", "鋤": "锄", "錯": "错", "錦": "锦", "鍵": "键", "鏢": "镖", "鏡": "镜", "長": "长", "門": "门", "閃": "闪", "閉": "闭", "問": "问", "閒": "闲", "間": "间", "悶": "门", "鬧": "闹", "聞": "闻", "閡": "阂", "閱": "阅", "隊": "队", "防": "防", "陽": "阳", "陰": "阴", "陣": "阵", "階": "阶", "阻": "阻", "阿": "阿", "附": "附", "際": "际", "陸": "陆", "陳": "陈", "陋": "陋", "降": "降", "限": "限", "院": "院", "除": "除", "險": "险", "陪": "陪", "陶": "陶", "陷": "陷", "隨": "随", "隱": "隐", "隔": "隔", "隘": "隘", "障": "障", "隸": "隶", "難": "难", "雄": "雄", "集": "集", "雇": "雇", "僱": "雇", "雛": "雏", "雨": "雨", "零": "零", "雷": "雷", "需": "需", "霄": "霄", "露": "露", "青": "青", "靜": "静", "非": "非", "靠": "靠", "面": "面", "革": "革", "鞋": "鞋", "鞭": "鞭", "韓": "韩", "音": "音", "頁": "页", "頂": "顶", "頃": "顷", "項": "项", "順": "顺", "須": "须", "顧": "顾", "頓": "顿", "頌": "颂", "預": "预", "領": "领", "頗": "颇", "頻": "频", "穎": "题", "題": "题", "額": "额", "風": "风", "飛": "飞", "食": "食", "餐": "餐", "饑": "饥", "飯": "饭", "飾": "饰", "飽": "饱", "餅": "饼", "餓": "饿", "館": "馆", "首": "首", "香": "香", "馬": "马", "馭": "驭", "驅": "驱", "駁": "驳", "駝": "驼", "駕": "驾", "罵": "骂", "駱": "骆", "驗": "验", "騎": "骑", "騙": "骗", "驟": "骤", "骨": "骨", "髓": "髓", "高": "高", "鬼": "鬼", "魂": "魂", "魏": "魏", "魚": "鱼", "魯": "鲁", "鮮": "鲜", "鳴": "鸣", "鴨": "鸭", "鴦": "鸯", "鴛": "鸳", "鷹": "鹰", "鹿": "鹿", "麻": "麻", "黃": "黄", "黑": "黑", "鼎": "鼎", "鼓": "鼓", "鼠": "鼠", "齊": "齐", "齒": "齿", "龍": "龙", "櫻": "樱", "劍": "剑"
};

/**
 * 內置轉換函數
 */
function convertToSimplifiedLocal(text: string): string {
    if (!text) return '';
    return text.split('').map(char => T2S_MAP[char] || char).join('');
}

/**
 * 從單一資源站搜尋影片
 */
async function searchVideosBySource(
    query: string,
    source: VideoSource,
    page: number = 1
): Promise<{ results: VideoItem[]; source: string; responseTime: number }> {
    const startTime = Date.now();

    const url = new URL(`${source.baseUrl}${source.searchPath}`);
    url.searchParams.set('ac', 'detail');
    url.searchParams.set('wd', query); 
    url.searchParams.set('pg', String(page));

    try {
        console.log(`[Search-API] 站點 [${source.name}] 搜尋 URL: ${url.toString()}`);
        
        const response = await withRetry(async () => {
            return await fetchWithTimeout(url.toString(), {
                method: 'GET',
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
                    ...source.headers,
                },
            });
        });

        const data: ApiSearchResponse = await response.json();
        const results: VideoItem[] = (Array.isArray(data.list) ? data.list : []).map(item => ({
            ...item,
            source: source.id,
        }));

        console.log(`[Search-API] 站點 [${source.name}] 找到 ${results.length} 筆`);

        return {
            results,
            source: source.id,
            responseTime: Date.now() - startTime,
        };
    } catch (error) {
        console.error(`[Search-API] 站點 [${source.name}] 錯誤:`, error);
        return { results: [], source: source.id, responseTime: 0 };
    }
}

/**
 * 並行搜尋入口
 */
export async function searchVideos(
    query: string,
    sources: VideoSource[],
    page: number = 1
): Promise<Array<{ results: VideoItem[]; source: string; responseTime?: number; error?: string }>> {
    
    // 1. 使用本地字典執行簡繁轉換（無網路請求）
    const simplifiedQuery = convertToSimplifiedLocal(query);
    console.log(`[Search-API] 收到搜尋: "${query}" -> 轉換為簡體: "${simplifiedQuery}"`);

    // 2. 執行並行搜尋
    const searchPromises = sources.map(async source => {
        try {
            return await searchVideosBySource(simplifiedQuery, source, page);
        } catch (error) {
            return {
                results: [],
                source: source.id,
                error: error instanceof Error ? error.message : 'Unknown error',
            };
        }
    });

    const results = await Promise.all(searchPromises);
    const total = results.reduce((acc, curr) => acc + curr.results.length, 0);
    console.log(`[Search-API] 搜尋結束，總計找到 ${total} 筆結果`);

    return results;
}
